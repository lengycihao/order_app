# 桌台点餐系统交接文档

## 项目概述

本项目是一个基于Flutter的餐厅点餐系统，主要包含桌台管理和点餐功能两个核心模块。系统采用GetX状态管理，支持WebSocket实时通信，具备完整的购物车管理和订单处理功能。

## 目录结构

```
lib/pages/
├── table/                    # 桌台管理模块
│   ├── table_page.dart      # 桌台主页面
│   ├── table_controller.dart # 桌台控制器
│   ├── card/                # 桌台卡片组件
│   ├── components/          # 通用组件
│   ├── services/           # 服务层
│   ├── state/              # 状态管理
│   ├── sub_page/           # 子页面
│   ├── tools/              # 工具类
│   └── utils/              # 工具函数
└── order/                   # 点餐模块
    ├── order_main_page.dart # 点餐主页面
    ├── order_element/      # 核心业务逻辑
    ├── components/         # UI组件
    ├── services/          # 服务层
    ├── tabs/              # Tab页面
    ├── model/             # 数据模型
    └── utils/              # 工具函数
```

## 一、桌台管理模块 (Table Module)

### 1.1 核心文件说明

#### `table_page.dart` - 桌台主页面
- **功能**: 桌台列表展示和管理
- **特点**: 
  - 继承自 `BaseListPageWidget`，具备下拉刷新和骨架屏功能
  - 支持多大厅Tab切换
  - 集成并桌功能
  - 实时数据更新和预加载机制

#### `table_controller.dart` - 桌台控制器
- **功能**: 桌台页面状态管理和业务逻辑
- **核心状态**:
  - `selectedTab`: 当前选中的Tab索引
  - `tabDataList`: 各Tab的桌台数据列表
  - `lobbyListModel`: 大厅列表数据
  - `isMergeMode`: 并桌模式状态
  - `selectedTables`: 选中的桌台列表

### 1.2 服务层架构

#### `TableDataService` - 数据服务
```dart
class TableDataService {
  // 获取大厅列表
  Future<HttpResultN<LobbyListModel>> getLobbyList()
  
  // 获取桌台列表
  Future<HttpResultN<List<TableListModel>>> getTableList(String hallId)
  
  // 获取桌台菜单
  Future<HttpResultN<List<TableMenuListModel>>> getTableMenuList(String tableId)
}
```

#### `TablePreloadManager` - 预加载管理
- **功能**: 管理Tab切换时的数据预加载
- **特点**: 智能预加载策略，提升用户体验

#### `TablePollingManager` - 轮询管理
- **功能**: 定时刷新桌台状态
- **特点**: 可配置的轮询间隔，网络异常处理

#### `TableWebSocketManager` - WebSocket管理
- **功能**: 实时接收桌台状态变更
- **特点**: 自动重连，消息去重

### 1.3 主要功能

#### 桌台状态管理
- **空闲**: 可点餐状态
- **用餐中**: 正在使用状态
- **已预订**: 预约状态
- **维护中**: 不可用状态

#### 并桌功能
- 支持多桌合并
- 实时状态同步
- 操作确认机制

#### 菜单选择
- 根据桌台类型显示对应菜单
- 支持人数选择
- 菜单缓存机制

## 二、点餐模块 (Order Module)

### 2.1 核心文件说明

#### `order_main_page.dart` - 点餐主页面
- **功能**: 点餐流程的主入口
- **特点**:
  - Tab切换：点餐Tab + 已点Tab
  - 支持桌台点餐和外卖点餐
  - 集成购物车和订单提交

#### `order_controller.dart` - 订单控制器
- **功能**: 点餐页面核心业务逻辑
- **核心状态**:
  - `dishes`: 菜品列表
  - `cart`: 购物车数据
  - `categories`: 菜品分类
  - `selectedCategory`: 当前选中分类
  - `currentOrder`: 当前订单信息

### 2.2 服务层架构

#### `OrderCoordinator` - 订单协调器
- **功能**: 协调各个子控制器的交互
- **子控制器**:
  - `CartController`: 购物车管理
  - `DishController`: 菜品管理
  - `AllergenController`: 过敏原管理

#### `CartManager` - 购物车管理器
```dart
class CartManager {
  // 添加菜品到购物车
  Future<void> addToCart(CartItem item, int quantity)
  
  // 更新购物车数量
  Future<void> updateCartQuantity(CartItem item, int quantity)
  
  // 从购物车移除
  Future<void> removeFromCart(CartItem item)
  
  // 清空购物车
  Future<void> clearCart()
}
```

#### `WebSocketHandler` - WebSocket处理器
- **功能**: 处理实时订单状态更新
- **特点**: 消息去重，错误重试

### 2.3 主要功能

#### 菜品管理
- **分类展示**: 按菜品分类组织展示
- **搜索功能**: 支持关键词搜索
- **排序功能**: 价格升序/降序
- **过敏原过滤**: 根据过敏原筛选菜品

#### 购物车功能
- **规格选择**: 支持菜品规格选择
- **数量控制**: 增减数量操作
- **实时同步**: WebSocket实时同步
- **本地缓存**: 离线状态下的本地操作

#### 订单处理
- **订单提交**: 完整的订单提交流程
- **状态跟踪**: 实时订单状态更新
- **错误处理**: 网络异常和业务异常处理

## 三、数据模型

### 3.1 核心数据模型

#### `TableListModel` - 桌台模型
```dart
class TableListModel {
  final int tableId;
  final String tableName;
  final String tableStatus;
  final String? hallId;
  // ... 其他字段
}
```

#### `Dish` - 菜品模型
```dart
class Dish {
  final int id;
  final String name;
  final String description;
  final double price;
  final List<DishOption> options;
  final bool hasOptions;
  // ... 其他字段
}
```

#### `CartItem` - 购物车项模型
```dart
class CartItem {
  final Dish dish;
  final Map<String, List<String>> selectedOptions;
  final String? cartSpecificationId;
  final int? cartItemId;
  final int? cartId;
}
```

## 四、技术特点

### 4.1 状态管理
- **GetX**: 响应式状态管理
- **RxDart**: 响应式编程
- **依赖注入**: GetX的依赖注入机制

### 4.2 网络通信
- **HTTP API**: RESTful API调用
- **WebSocket**: 实时数据同步
- **错误处理**: 统一的错误处理机制
- **重试机制**: 网络异常自动重试

### 4.3 UI/UX特性
- **骨架屏**: 加载状态优化
- **下拉刷新**: 数据刷新机制
- **空状态**: 友好的空数据展示
- **错误状态**: 网络错误处理

### 4.4 性能优化
- **预加载**: Tab数据预加载
- **缓存机制**: 数据本地缓存
- **防抖处理**: WebSocket消息防抖
- **懒加载**: 按需加载数据

## 五、关键业务流程

### 5.1 桌台点餐流程
1. **选择桌台** → 2. **选择菜单** → 3. **选择人数** → 4. **进入点餐页面** → 5. **添加菜品** → 6. **提交订单**

### 5.2 购物车操作流程
1. **选择菜品** → 2. **选择规格** → 3. **确认数量** → 4. **加入购物车** → 5. **实时同步** → 6. **提交订单**

### 5.3 WebSocket通信流程
1. **建立连接** → 2. **订阅消息** → 3. **接收更新** → 4. **处理消息** → 5. **更新UI** → 6. **错误重连**

## 六、开发注意事项

### 6.1 代码规范
- 使用GetX状态管理
- 遵循Flutter代码规范
- 统一的错误处理
- 完善的日志记录

### 6.2 性能考虑
- 避免不必要的重建
- 合理使用Obx和GetBuilder
- 及时释放资源
- 优化网络请求

### 6.3 测试建议
- 单元测试覆盖核心业务逻辑
- 集成测试验证完整流程
- UI测试确保界面正确性
- 网络异常场景测试

## 七、常见问题处理

### 7.1 网络异常
- 检查网络连接状态
- 实现重试机制
- 提供友好的错误提示
- 支持离线操作

### 7.2 状态同步
- WebSocket连接状态监控
- 消息去重处理
- 本地状态与服务器状态一致性
- 异常情况下的状态恢复

### 7.3 性能问题
- 监控页面渲染性能
- 优化数据加载策略
- 减少不必要的API调用
- 合理使用缓存机制

## 八、扩展建议

### 8.1 功能扩展
- 支持更多支付方式
- 增加订单历史查询
- 添加用户评价功能
- 实现优惠券系统

### 8.2 技术优化
- 引入状态管理最佳实践
- 优化网络层架构
- 增加单元测试覆盖率
- 实现自动化部署

---

**文档版本**: v1.0  
**最后更新**: 2024年12月  
**维护人员**: 开发团队
