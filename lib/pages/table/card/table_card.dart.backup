import 'package:flutter/material.dart';
import 'package:order_app/cons/table_status.dart';
import 'package:order_app/pages/table/card/animate_hour.dart';
import 'package:lib_domain/entrity/home/table_list_model/table_list_model.dart';
import 'package:marquee/marquee.dart';
import 'package:order_app/pages/table/sub_page/select_menu_page.dart';
import 'package:order_app/pages/table/tools/change_table_status_dialog.dart';
import 'package:lib_domain/entrity/home/table_menu_list_model/table_menu_list_model.dart';
import 'package:get/get.dart';
import 'package:order_app/pages/table/table_controller.dart';
import 'package:order_app/pages/order/order_main_page.dart';
import 'package:order_app/utils/snackbar_utils.dart';
import 'package:order_app/utils/screen_adaptation.dart';

class TableCard extends StatefulWidget {
  final TableListModel table;
  final List<TableMenuListModel> tableModelList;
  final bool isSelected; // æ·»åŠ é€‰ä¸­çŠ¶æ€å‚æ•°
  final bool isMergeMode; // æ·»åŠ å¹¶æ¡Œæ¨¡å¼å‚æ•°
  
  static const int _debounceDelay = 500; // 500msé˜²æŠ–ï¼Œæ›´åˆç†çš„å“åº”æ—¶é—´

  const TableCard({
    Key? key,
    required this.table,
    required this.tableModelList,
    this.isSelected = false,
    this.isMergeMode = false,
  }) : super(key: key);

  @override
  State<TableCard> createState() => _TableCardState();
}

class _TableCardState extends State<TableCard> {
  // é˜²æŠ–å¤„ç† - æ¯ä¸ªæ¡Œå°å®ä¾‹ç‹¬ç«‹çš„é˜²æŠ–æ—¶é—´
  int _lastClickTime = 0;

  Color _getStatusColor(TableStatus status) {
    switch (status) {
      case TableStatus.Unavailable:
        return Color(0xff999999);
      case TableStatus.PendingBill:
        return Color(0xffF47E97);
      case TableStatus.PreBilled:
        return Color(0xff77DD77);
      case TableStatus.WaitingOrder:
        return Color(0xffFFD700);
      case TableStatus.Empty:
        return Colors.white;
      case TableStatus.Occupied:
        return Color(0xff999999);
      case TableStatus.Maintenance:
        return Color(0xff999999);
      case TableStatus.Reserved:
        return Color(0xff999999);
    }
  }

  Color _getStatusBottomColor(TableStatus status) {
    switch (status) {
      case TableStatus.Unavailable:
        return Color(0xff666666);
      case TableStatus.PendingBill:
        return Color(0xffFF6B8B);
      case TableStatus.PreBilled:
        return Color(0xff55CB55);
      case TableStatus.WaitingOrder:
        return Color(0xffEAC500);
      case TableStatus.Empty:
        return Color(0xffE4E4E4);
      case TableStatus.Occupied:
        return Color(0xff666666);
      case TableStatus.Maintenance:
        return Color(0xff666666);
      case TableStatus.Reserved:
        return Color(0xff666666);
    }
  }

  TableStatus _getStatus(int status) {
    switch (status) {
      case 0:
        return TableStatus.Empty;
      case 1:
        return TableStatus.Occupied;
      case 2:
        return TableStatus.WaitingOrder;
      case 3:
        return TableStatus.PendingBill;
      case 4:
        return TableStatus.PreBilled;
      case 5:
        return TableStatus.Unavailable; // ä¿®å¤ï¼š5åº”è¯¥æ˜¯ä¸å¯ç”¨çŠ¶æ€
      case 6:
        return TableStatus.Maintenance;
      case 7:
        return TableStatus.Reserved;
    }
    return TableStatus.Empty;
  }

  @override
  Widget build(BuildContext context) {
    final status = _getStatus(widget.table.businessStatus.toInt());
    // final canMerge = status != TableStatus.Unavailable && status != TableStatus.Maintenance;
    return GestureDetector(
      onLongPress: widget.isMergeMode ? null : () {
        showDialog(
          context: context,
          builder: (_) => ChangeTableStatusDialog(
            tableNo: widget.table.tableName ?? "",
            status: status,
            onClose: () => Navigator.of(context).pop(),
            onChangeStatus: (newStatus) async {
              Navigator.of(context).pop();
              
              // è·å–TableControllerå®ä¾‹
              final controller = Get.find<TableController>();
              
              // è°ƒç”¨APIåˆ‡æ¢æ¡Œå°çŠ¶æ€
              await controller.changeTableStatus(
                tableId: widget.table.tableId.toInt(),
                newStatus: newStatus,
              );
            },
          ),
        );
      },
      onTap: widget.isMergeMode ? null : () async {
        // é˜²æŠ–å¤„ç†
        final currentTime = DateTime.now().millisecondsSinceEpoch;
        if (currentTime - _lastClickTime < TableCard._debounceDelay) {
          print('ğŸš« ç‚¹å‡»è¿‡äºé¢‘ç¹ï¼Œå¿½ç•¥æ­¤æ¬¡ç‚¹å‡»');
          return;
        }
        _lastClickTime = currentTime;
        
        try {
          // ç›´æ¥ä½¿ç”¨å½“å‰æ¡Œå°æ•°æ®ï¼Œä¸è¯·æ±‚è¯¦æƒ…
          final currentTable = widget.table;
          final status = _getStatus(currentTable.businessStatus.toInt());
          
          // å¦‚æœæ˜¯ä¸å¯ç”¨æˆ–ç»´ä¿®çŠ¶æ€çš„æ¡Œå°ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
          if (status == TableStatus.Unavailable || status == TableStatus.Maintenance) {
            String message = status == TableStatus.Unavailable ? 'è¯¥æ¡Œå°å½“å‰ä¸å¯ç”¨' : 'è¯¥æ¡Œå°æ­£åœ¨ç»´ä¿®ä¸­';
            SnackbarUtils.showWarning(context, message);
            return;
          }
          
          // æ ¹æ®çŠ¶æ€å†³å®šè·³è½¬é¡µé¢
          if (currentTable.businessStatus == 0) {
            // çŠ¶æ€0ï¼šè¿›å…¥èœå•é€‰æ‹©é¡µé¢
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => SelectMenuPage(),
                settings: RouteSettings(
                  arguments: {
                    'table': currentTable,
                    'menu': widget.tableModelList,
                    'table_id': currentTable.tableId,
                  },
                ),
              ),
            );
          } else {
            // å…¶ä»–çŠ¶æ€ï¼ˆé™¤äº†5,6ï¼‰ï¼šç›´æ¥è¿›å…¥ç‚¹é¤é¡µé¢
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => OrderMainPage(),
                settings: RouteSettings(
                  arguments: {
                    'table_id': currentTable.tableId,
                    // ä¿®å¤äººæ•°æ•°æ®ä¼ é€’é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨å½“å‰äººæ•°ï¼Œå¦‚æœä¸º0åˆ™ä½¿ç”¨æ ‡å‡†äººæ•°
                    'adult_count': currentTable.currentAdult > 0 ? currentTable.currentAdult.toInt() : currentTable.standardAdult.toInt(),
                    'child_count': currentTable.currentChild.toInt(),
                    'menu': widget.tableModelList, // æ·»åŠ èœå•åˆ—è¡¨ï¼Œç”¨äºè·å–èœå“æ•°æ®
                  },
                ),
              ),
            );
          }
        } catch (e) {
          print('æ¡Œå°ç‚¹å‡»å¤„ç†å¼‚å¸¸: $e');
          SnackbarUtils.showError(context, 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      },
      child: Container(
        width: context.adaptWidth(165),
        height: context.adaptHeight(124),
        decoration: BoxDecoration(
          color: _getStatusColor(status),
          borderRadius: BorderRadius.circular(context.adaptWidth(12)), // å¢åŠ åœ†è§’
          border: widget.isSelected && widget.isMergeMode 
            ? Border.all(
                color: Color(0xffFF9027), 
                width: 2.0
              ) 
            : null,
          boxShadow: [
            BoxShadow(
              offset: Offset(0, context.adaptHeight(1)),
              blurRadius: context.adaptWidth(3),
              spreadRadius: 0,
              color: Color(0x33000000), // 000000 20% é€æ˜åº¦
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          mainAxisSize: MainAxisSize.min,
          children: [
            // æ¡Œå· & äººæ•°
            Container(
              padding: EdgeInsets.all(context.adaptWidth(8)),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // æ¡Œå - æ”¯æŒå¤šè¡Œæ˜¾ç¤ºï¼Œæœ€å¤š2è¡Œ
                  Expanded(
                    flex: 2,
                    child: Text(
                      widget.table.tableName ?? "æ¡Œå°${widget.table.tableId}",
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        fontSize: context.adaptFontSize(14),
                        color: Colors.black, // ç¡®ä¿æ–‡å­—é¢œè‰²å¯è§
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                  SizedBox(width: context.adaptWidth(8)), // æ·»åŠ é—´è·
                  // äººæ•°ä¿¡æ¯ - å›ºå®šåœ¨å³ä¾§
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      // æˆäººäººæ•°
                      Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                        Image.asset(
                          'assets/order_table_person_icon.webp',
                          width: context.adaptWidth(8),
                          height: context.adaptHeight(8),
                        ),
                        SizedBox(width: context.adaptWidth(3)),
                        (widget.table.currentAdult > 0)
                            ? Text(
                                '${widget.table.currentAdult}/${widget.table.standardAdult}',
                                style: TextStyle(
                                  fontSize: context.adaptFontSize(10),
                                  fontWeight: FontWeight.w500,
                                ),
                              )
                            : Text(
                                widget.table.standardAdult.toString(),
                                style: TextStyle(
                                  fontSize: context.adaptFontSize(10),
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                          ],
                        ),
                      if (widget.table.standardChild > 0)
                        Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Image.asset(
                              'assets/order_table_child_icon.webp',
                              width: context.adaptWidth(8),
                              height: context.adaptHeight(8),
                            ),
                            SizedBox(width: context.adaptWidth(3)),
                            (widget.table.currentChild > 0)
                                ? Text(
                                    '${widget.table.currentChild}/${widget.table.standardChild}',
                                    style: TextStyle(
                                      fontSize: context.adaptFontSize(10),
                                      fontWeight: FontWeight.w500,
                                    ),
                                  )
                                : Text(
                                    widget.table.standardChild.toString(),
                                    style: TextStyle(
                                      fontSize: context.adaptFontSize(10),
                                      fontWeight: FontWeight.w500,
                                    ),
                                  ),
                          ],
                        ),
                      ],
                    ),
                  ],
                ),
              ),
              // ä½¿ç”¨Expandedå’ŒCenteræ¥å°†é‡‘é¢æ”¾åœ¨æ­£ä¸­å¤®
              Expanded(
                child: widget.table.businessStatus == 3
                    ? Center(
                        child: Text(
                          'â‚¬ ${widget.table.orderAmount.toStringAsFixed(2)}',
                          style: TextStyle(
                            color: Colors.black,
                            fontSize: context.adaptFontSize(18),
                            fontWeight: FontWeight.bold,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      )
                    : SizedBox(),
              ),
              // çŠ¶æ€ & æ—¶é—´ - å›ºå®šåœ¨åº•éƒ¨
              _getStatusLabel(context, status),
            ],
          ),
        ),
      ),
    );
  }

  Widget _getStatusLabel(BuildContext context, TableStatus status) {
    // çŠ¶æ€ & æ—¶é—´
    return Container(
      height: context.adaptHeight(28), // å¢åŠ é«˜åº¦ç¡®ä¿å†…å®¹å¯è§
      padding: EdgeInsets.symmetric(horizontal: context.adaptWidth(10), vertical: context.adaptHeight(4)),
      decoration: BoxDecoration(
        color: _getStatusBottomColor(status),
        borderRadius: BorderRadius.only(
          bottomLeft: Radius.circular(context.adaptWidth(8)),
          bottomRight: Radius.circular(context.adaptWidth(8)),
        ),
      ),
      child: Row(
        children: [
          // å·¦ä¾§ï¼šçŠ¶æ€æ–‡å­—
          Expanded(
            child: _buildStatusText(context, status),
          ),
          // å³ä¾§ï¼šæ—¶é—´æ˜¾ç¤º
          if (widget.table.businessStatus == 1 ||
              widget.table.businessStatus == 2 ||
              widget.table.businessStatus == 3) ...[
            SizedBox(width: context.adaptWidth(8)),
            AnimatedHourglass(
              initialDuration: widget.table.openDuration,
              tableId: widget.table.tableId.toString(),
            ),
          ],
        ],
      ),
    );
  }

  Widget _buildStatusText(BuildContext context, TableStatus status) {
    String text = '';
    switch (status) {
      case TableStatus.Empty:
        text = 'ç©ºé—²';
        break;
      case TableStatus.Occupied:
        text = 'å·²å ç”¨';
        break;
      case TableStatus.WaitingOrder:
        text = 'ç­‰å¾…ç‚¹é¤';
        break;
      case TableStatus.PendingBill:
        text = 'å¾…ç»“è´¦';
        break;
      case TableStatus.PreBilled:
        text = 'é¢„ç»“è´¦';
        break;
      case TableStatus.Unavailable:
        text = 'ä¸å¯ç”¨';
        break;
      case TableStatus.Maintenance:
        text = 'ç»´ä¿®ä¸­';
        break;
      case TableStatus.Reserved:
        text = 'å·²é¢„è®¢';
        break;
    }

    return LayoutBuilder(
      builder: (context, constraints) {
        // é™åˆ¶æœ€å¤§å®½åº¦ä¸ºçˆ¶å®¹å™¨çš„ 3/4
        final maxWidth = constraints.maxWidth * 0.75;

        // ç”¨ TextPainter è®¡ç®—æ–‡å­—å®½åº¦
        final textPainter = TextPainter(
          text: TextSpan(
            text: text,
            style: TextStyle(
              fontSize: context.adaptFontSize(12), 
              color: Colors.black
            ),
          ),
          maxLines: 1,
          textDirection: TextDirection.ltr,
        )..layout(minWidth: 0, maxWidth: double.infinity);

        final textWidth = textPainter.size.width;

        // å¦‚æœæ–‡å­—å®½åº¦å°äºæœ€å¤§å®½åº¦ï¼Œç›´æ¥æ˜¾ç¤º
        if (textWidth <= maxWidth) {
          return Text(
            text,
            style: TextStyle(
              fontSize: context.adaptFontSize(12), 
              color: Colors.black,
              fontWeight: FontWeight.w500, // å¢åŠ å­—ä½“ç²—ç»†
            ),
            overflow: TextOverflow.ellipsis,
            maxLines: 1,
          );
        } else {
          // å¦åˆ™ä½¿ç”¨è·‘é©¬ç¯æ•ˆæœ
          return SizedBox(
            width: maxWidth,
            height: context.adaptHeight(20), // å›ºå®šé«˜åº¦ï¼Œé¿å…è·³åŠ¨
            child: Marquee(
              text: text,
              style: TextStyle(
                fontSize: context.adaptFontSize(12), 
                color: Colors.black,
                fontWeight: FontWeight.w500, // å¢åŠ å­—ä½“ç²—ç»†
              ),
              scrollAxis: Axis.horizontal,
              crossAxisAlignment: CrossAxisAlignment.center,
              blankSpace: context.adaptWidth(30.0),
              velocity: 30.0,
              startPadding: context.adaptWidth(5.0),
              pauseAfterRound: const Duration(seconds: 1),
              showFadingOnlyWhenScrolling: true,
              fadingEdgeStartFraction: 0.1,
              fadingEdgeEndFraction: 0.1,
            ),
          );
        }
      },
    );
  }
}